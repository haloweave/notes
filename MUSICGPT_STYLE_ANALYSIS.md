# MusicGPT API - Music Style Analysis

## Investigation Summary

**Form ID:** `form_1766444920014_znzifv475`

**Issue:** A sad/melancholic song was generated despite the user selecting "bright-uplifting" style with joyful, loving emotions.

---

## Current Implementation

### 1. Form Data Collected

From `components/create/song-form.tsx`, the user selected:

```javascript
{
  "style": "bright-uplifting",  // User's primary style choice
  "vibe": "loving",
  "emotions": "joy",
  "theme": "happy-holidays",
  "festiveSoundLevel": "festive"
}
```

### 2. Available Style Options in Form

```javascript
const styles = [
  { value: "classic-timeless", label: "Classic & Timeless", description: "Traditional, rich, classic" },
  { value: "soft-heartfelt", label: "Soft & Heartfelt", description: "Slow, intimate, gentle" },
  { value: "bright-uplifting", label: "Bright & Uplifting", description: "Fun, energetic, celebratory" }, // ✅ USER SELECTED THIS
  { value: "romantic-heartfelt", label: "Romantic & Heartfelt", description: "Deeply emotional, romantic, tender" },
  { value: "warm-cosy", label: "Warm & Cosy", description: "Comforting, homely, gentle" },
  { value: "orchestral-festive", label: "Orchestral & Festive", description: "Majestic, elegant, celebratory" }
];
```

### 3. How `music_style` is Currently Generated

**File:** `/app/api/create-song-prompt/route.ts` (Lines 144-174)

```typescript
// Generate music_style from user's form selections
const musicStyleComponents = [];

// Add user's selected style (if provided)
if (formData.style) {
    musicStyleComponents.push(formData.style);  // ✅ "bright-uplifting"
}

// Add vibe (e.g., "loving", "joyful", "melancholic")
if (formData.vibe) {
    musicStyleComponents.push(formData.vibe);  // ✅ "loving"
}

// Add festive sound level for Christmas/holiday themes
if (formData.festiveSoundLevel) {
    const festiveMap = {
        'lightly-festive': 'subtle festive elements',
        'moderately-festive': 'festive, holiday spirit',
        'very-festive': 'very festive, celebratory, holiday cheer'
    };
    const festiveStyle = festiveMap[formData.festiveSoundLevel];
    if (festiveStyle) {
        musicStyleComponents.push(festiveStyle);  // ✅ "festive, holiday spirit"
    }
}

// Construct final music_style string
const music_style = musicStyleComponents.join(', ') || 'heartfelt, personalized';
```

**Result for this form:**
```javascript
music_style = "bright-uplifting, loving, festive, holiday spirit"
```

### 4. How `music_style` is Sent to MusicGPT

**File:** `/app/api/generate/route.ts` (Lines 79-86)

```typescript
body: JSON.stringify({
    prompt: body.prompt,
    music_style: body.music_style || undefined,  // ✅ Passed correctly
    make_instrumental: body.make_instrumental || false,
    wait_audio: false,
    webhook_url: webhookUrl,
    num_outputs: 1
})
```

---

## MusicGPT API Documentation

### Official Parameter Definition

From https://docs.musicgpt.com/api-documentation/endpoint/MusicAI:

```
music_style (string, optional)
Style of music to generate (e.g., Rock, Pop)
```

### Accepted Values

MusicGPT **does NOT provide a predefined list** of accepted values. The documentation only shows examples:
- Rock
- Pop
- Lo-fi
- Acoustic
- Christmas Vibes
- Emotional
- House Essentials
- Afrobeat
- Classical
- Country
- R&B

**Key Finding:** MusicGPT accepts **natural language descriptions** for `music_style`, not just single-word genres.

---

## Problem Analysis

### Why Sad Songs Were Generated

Looking at the database results for `form_1766444920014_znzifv475`:

**Generated Variations:**

1. **Variation 1** ("Perry's List") - ✅ Upbeat and positive
2. **Variation 2** ("The Yacht Went Sideways") - ❌ Melancholic, reflective
3. **Variation 3** ("For Perry") - ❌ Literary, somber

**Root Cause:**

The issue is **NOT** with how you're passing `music_style` to MusicGPT. The problem is:

1. **The `music_style` parameter is being passed correctly** as `"bright-uplifting, loving, festive, holiday spirit"`

2. **However, the variation styles are overriding the base music style:**

From the database:
```json
{
  "music_styles": ["bright-uplifting, loving"],
  "variation_styles": [
    ["Cheerful holiday spirit", "Vibrant joyful sound", "Bright festive melody"]
  ]
}
```

3. **The variation generation logic** (in `/app/compose/variations/page.tsx`) is creating 3 different prompts by combining:
   - Base prompt
   - Base music_style
   - **PLUS** a variation style modifier

4. **The AI-generated variation styles** are too generic and don't enforce the "bright-uplifting" constraint strongly enough.

---

## The Real Issue

### Current Variation Generation

**File:** `/app/api/create-song-prompt/route.ts` (Lines 176-236)

The variation styles are generated by AI with this prompt:

```typescript
const variationPrompt = `Based on this song context:
- Theme: ${formData.theme}
- Emotions: ${formData.emotions}
- Vibe: ${formData.vibe}
- Style: ${formData.style || 'not specified'}  // ✅ "bright-uplifting" is included
- Festive Level: ${formData.festiveSoundLevel || 'not specified'}

Generate 3 DIFFERENT but contextually appropriate musical variation descriptors...`;
```

**Problem:** The AI is generating variations that are "contextually appropriate" but **not enforcing the primary style constraint**.

For this form, it generated:
- "Cheerful holiday spirit" ✅
- "Vibrant joyful sound" ✅
- "Bright festive melody" ✅

These **look correct**, but when MusicGPT interprets them, it's creating different musical interpretations that don't all match "bright-uplifting".

---

## Recommendations

### ✅ **Option 1: Use `music_style` as the Primary Constraint (RECOMMENDED)**

Instead of passing custom variation descriptors, **use the user's selected `style` value directly** as the `music_style` parameter, and let MusicGPT handle variations naturally.

**Change in `/app/api/generate/route.ts`:**

```typescript
// CURRENT:
music_style: body.music_style || undefined,  // "bright-uplifting, loving, festive, holiday spirit"

// RECOMMENDED:
music_style: body.primary_style || body.music_style || undefined,  // Just "bright-uplifting"
```

**Why this works:**
- MusicGPT accepts natural language descriptions
- "bright-uplifting" is descriptive enough for MusicGPT to understand
- The prompt already contains all the personalization details
- The festive elements can be in the prompt, not the music_style

### ✅ **Option 2: Map Custom Styles to Standard Genres**

Create a mapping from your custom style values to standard music genres that MusicGPT recognizes better:

```typescript
const styleToGenreMap = {
  "bright-uplifting": "Pop, Upbeat, Energetic",
  "soft-heartfelt": "Acoustic Ballad, Soft, Intimate",
  "classic-timeless": "Classic Pop, Timeless",
  "romantic-heartfelt": "Romantic Ballad, Emotional",
  "warm-cosy": "Acoustic, Warm, Cozy",
  "orchestral-festive": "Orchestral, Festive, Celebratory"
};

const music_style = styleToGenreMap[formData.style] || formData.style;
```

### ✅ **Option 3: Enforce Style in Variation Generation**

Update the variation style generation prompt to **strongly enforce** the primary style:

```typescript
const variationPrompt = `Based on this song context:
- PRIMARY STYLE (MUST MAINTAIN): ${formData.style}  // "bright-uplifting"
- Theme: ${formData.theme}
- Emotions: ${formData.emotions}
- Vibe: ${formData.vibe}

CRITICAL: All 3 variations MUST maintain the "${formData.style}" style.
Generate 3 DIFFERENT but contextually appropriate musical variation descriptors that are ALL ${formData.style}.

For example, if the style is "bright-uplifting", ALL variations must be upbeat, energetic, and celebratory.
If the style is "soft-heartfelt", ALL variations must be gentle, intimate, and tender.

Output ONLY 3 short descriptors (2-4 words each), separated by " | ".`;
```

---

## Immediate Fix

### **Use the Primary Style Value Directly**

**File:** `/app/api/create-song-prompt/route.ts` (Line 172)

**CURRENT:**
```typescript
const music_style = musicStyleComponents.join(', ') || 'heartfelt, personalized';
// Result: "bright-uplifting, loving, festive, holiday spirit"
```

**RECOMMENDED:**
```typescript
// Use ONLY the primary style from the form
const music_style = formData.style || 'heartfelt, personalized';
// Result: "bright-uplifting"
```

**Why this is better:**
1. **Simpler and more direct** - MusicGPT gets a clear, single style directive
2. **Prevents conflicting descriptors** - "loving" and "festive" can be interpreted differently
3. **The prompt already contains all personalization** - emotions, vibe, memories are in the prompt
4. **MusicGPT's `music_style` parameter is meant for MUSICAL style, not emotional tone**

---

## Testing Recommendation

Test with the same form data but different `music_style` values:

1. **Test 1:** `music_style: "bright-uplifting"`
2. **Test 2:** `music_style: "Pop, Upbeat, Energetic"`
3. **Test 3:** `music_style: "bright-uplifting, loving, festive, holiday spirit"` (current)

Compare the generated songs to see which produces the most consistent results.

---

## Conclusion

**You ARE passing `music_style` correctly to MusicGPT.**

The issue is:
1. **Too many descriptors** in the `music_style` string may be confusing MusicGPT
2. **The variation styles** are not strongly enforcing the primary style constraint
3. **MusicGPT interprets natural language freely**, so simpler is often better

**Recommended Action:**
Use the user's selected `style` value (`"bright-uplifting"`) **directly** as the `music_style` parameter, without adding vibe or festive descriptors.
